<template>
  <div class="h-full flex flex-column p-3 surface-ground text-color">
    <div v-if="!selectedRouteDetails" class="flex align-items-center justify-content-center h-full">
        <h3 class="text-xl text-color-secondary">Select a route to build your request</h3>
    </div>
    <div v-else class="flex flex-column h-full">
      <!-- Request Method and URL Bar -->
      <div class="flex-shrink-0">
        <div class="flex align-items-center mb-3">
          <Dropdown
            v-model="requestMethod"
            :options="['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'HEAD']"
            placeholder="Method"
            class="w-8rem mr-2"
            :class="`method-${requestMethod}`"
            disabled
          />
          <InputText :value="finalUrl" class="flex-grow mr-2" placeholder="Request URL" readonly />
          <Button icon="pi pi-send" label="Send Request" :loading="apiStore.sendingRequest" @click="sendCurrentRequest" />
        </div>
      </div>

      <!-- Request Tabs -->
      <TabView class="flex-grow flex flex-column">
        <TabPanel header="Params" value="params">
            <div >
                <div v-if="pathParams.length > 0" class="mb-4">
                    <h4 class="text-lg font-bold mb-2">Path Parameters</h4>
                    <KeyValueEditor v-model="pathParams" key-readonly />
                </div>
                <div>
                    <h4 class="text-lg font-bold mb-2">Query Parameters</h4>
                    <KeyValueEditor v-model="queryParams" />
                </div>
            </div>
        </TabPanel>
        <TabPanel header="Headers" value="headers">
            <div class="overflow-auto no-scrollbar h-full">
                <h4 class="text-lg font-bold mb-2">Request Headers</h4>
                <KeyValueEditor v-model="headers" />
            </div>
        </TabPanel>
        <TabPanel v-if="requestMethod !== 'GET' && requestMethod !== 'HEAD' && requestMethod !== 'DELETE'" header="Body" value="body">
            <div class="p-4 overflow-auto no-scrollbar h-full">
                <h4 class="text-lg font-bold mb-2">Request Body (JSON)</h4>
                <CodeEditor v-model="requestBody" lang="json" height="100%" />
            </div>
        </TabPanel>
        <TabPanel header="Rules & Descriptions" value="rules">
            <div class="p-4 overflow-auto no-scrollbar h-full">
                <RulesTable v-if="selectedRouteDetails" :rules="selectedRouteDetails.rules" :field-info="selectedRouteDetails.field_info" />
            </div>
        </TabPanel>
      </TabView>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, watch, computed } from 'vue';
import { useApiStore } from '@/stores/api';
import { storeToRefs } from 'pinia';
import InputText from 'primevue/inputtext';
import Button from 'primevue/button';
import Dropdown from 'primevue/dropdown';
import TabView from 'primevue/tabview';
import TabPanel from 'primevue/tabpanel';
import RulesTable from '@/components/elements/RulesTable.vue';
import CodeEditor from '@/components/elements/CodeEditor.vue';
import KeyValueEditor from '@/components/elements/KeyValueEditor.vue';

type KeyValuePair = { key: string; value: string; };

const apiStore = useApiStore();
const { selectedRouteDetails } = storeToRefs(apiStore);

const requestUrl = ref('');
const requestMethod = ref('');
const requestBody = ref('');
const headers = ref<KeyValuePair[]>([]);
const queryParams = ref<KeyValuePair[]>([]);
const pathParams = ref<KeyValuePair[]>([]);

const finalUrl = computed(() => {
    let url = requestUrl.value;
    pathParams.value.forEach(param => {
        if (param.value) {
            url = url.replace(`{${param.key}}`, param.value);
        }
    });
    return url;
});

watch(selectedRouteDetails, (newDetails) => {
  if (newDetails) {
    requestUrl.value = newDetails.uri;
    requestMethod.value = newDetails.http_method;

    pathParams.value = (newDetails.uri.match(/\{(\w+)\}/g)?.map(p => ({ key: p.slice(1, -1), value: '' })) || []);

    headers.value = [{ key: 'Content-Type', value: 'application/json' }, { key: 'Accept', value: 'application/json' }];

    const examples = newDetails.examples;
    if (examples && Object.keys(examples).length > 0) {
        requestBody.value = JSON.stringify(examples, null, 2);
    } else {
        requestBody.value = buildBodyFromRules(newDetails.rules);
    }

    queryParams.value = buildParamsFromRules(newDetails.rules, 'query.');

  }
}, { immediate: true, deep: true });

function buildParamsFromRules(rules: any, prefix: string): KeyValuePair[] {
  if (!rules) return [];
  return Object.keys(rules)
    .filter(key => key.startsWith(prefix))
    .map(key => ({ key: key.replace(prefix, ''), value: '' }));
}

function buildBodyFromRules(rules: any): string {
  if (!rules) return '{}';
  const body: { [key: string]: any } = {};
  Object.keys(rules).forEach(key => {
    if (!key.includes('query.')) {
        body[key] = '';
    }
  });
  return JSON.stringify(body, null, 2);
}

function arrayToQueryString(params: KeyValuePair[]): string {
    const searchParams = new URLSearchParams();
    params.forEach(p => {
        if (p.key) searchParams.append(p.key, p.value);
    });
    const queryString = searchParams.toString();
    return queryString ? `?${queryString}` : '';
}

function arrayToHeadersObject(params: KeyValuePair[]): { [key: string]: string } {
    return params.reduce((acc, p) => {
        if (p.key) acc[p.key] = p.value;
        return acc;
    }, {} as { [key: string]: string });
}

const sendCurrentRequest = async () => {
    if (!selectedRouteDetails.value) return;

    apiStore.sendRequest(
        requestMethod.value,
        finalUrl.value,
        requestBody.value,
        JSON.stringify(arrayToHeadersObject(headers.value)),
        arrayToQueryString(queryParams.value)
    );
};
</script>

<style>
.p-tabview-panels {
  flex-grow: 1;
  overflow: auto;
  display: flex;
  flex-direction: column;
}
.p-tabview-panel {
    flex-grow: 1;
}
</style>